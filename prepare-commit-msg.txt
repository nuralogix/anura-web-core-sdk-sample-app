#!/bin/bash

# The Ticket ID prefix you want to include to your commit messages.
prefix='^([a-zA-Z][a-zA-Z][a-zA-Z]+/)?WM-'

# Gets the commit message received as parameter and the current branch name.
commitMsg=$1
message=$(cat "$commitMsg")
branchName=$(git symbolic-ref --short HEAD)

# Gets the last part of the branch name feature/WM-10263-This-is-the-branch -> WM-10263-This-is-the-branch
# branchName=$(cut -d "/" -f2 <<< "$branchName") <-- we want the entire prefix

# Checks if the message already includes the ticket ID.
if [[ $message =~ $prefix ]]; then
  echo "🆗 The message already has the ticket ID."
  exit 0
fi

if [[ $branchName =~ $prefix ]]; then
  echo "🧐 The current branch name contains the ticket ID. Trying to add it to the commit message..."

  # Takes from the beginning until the last number before the dash ((WM-10263)-This-is-the-branch-name).
  ticketID=$(echo "$branchName" | sed -nE 's,(^.*WM-[0-9]+)-.+,\1,p')

  if [[ -z $ticketID ]]; then
      echo "😢 Could not get the ticket ID."
      exit 1
  fi

  echo "🆔 ${ticketID}"
  output="$ticketID $message"
  echo "📩 $output"
  echo -e "$output" > "$1"

else
  echo "😐️ The current branch name does not contain the ticket ID '$ticketID'. Ignoring..."
  exit 0
fi